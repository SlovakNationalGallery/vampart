require 'rails_helper'

RSpec.describe DataRepository do
  subject { described_class }

  describe '.all' do
    it 'provides all data' do
      expect(subject.all.size).to eql(2164)
      expect(
        id: 'SVK:SNG.O_6269',
        source: 'api.webumenia.sk',
        year: 1846,
        dating: '1846',
        title: 'Podobizeň M.M.Hodžu',
        author: ["Klemens, Jozef Božetech"],
        url: 'http://webumenia.sk/dielo/SVK:SNG.O_6269',
        image_url: 'http://www.webumenia.sk/images/diela/SNG/13/SVK_SNG.O_6269/SVK_SNG.O_6269.jpeg',
        image: "0cb56d7d92b31fb8d6295c6a62ffc4641f468b1fd42012d29915d997ee67c000.jpg",
        faces: [
          {
            model: [
              -0.070131853222847,
              -0.04481178149581,
              -0.069011658430099,
              -0.072557657957077,
              0.0022364421747625,
              0.088504016399384,
              -0.03437303006649,
              -0.029162153601646,
              0.0080751162022352,
              0.1008924767375,
              0.075978294014931,
              0.056549210101366,
              0.053426921367645,
              0.16961933672428,
              -0.030102256685495,
              0.0027087572962046,
              -0.032455373555422,
              0.17384774982929,
              0.041358772665262,
              -0.072421655058861,
              0.037948809564114,
              0.028024105355144,
              0.11172909289598,
              0.027002384886146,
              -0.058293726295233,
              0.09267009049654,
              0.092050105333328,
              -0.030251421034336,
              0.020757099613547,
              0.024840582162142,
              -0.0030927639454603,
              -0.077840074896812,
              0.059348985552788,
              -0.079051248729229,
              0.016909390687943,
              0.064620442688465,
              -0.065154507756233,
              0.11808851361275,
              -0.030641287565231,
              0.10831362754107,
              -0.059736523777246,
              0.16276368498802,
              -0.078073941171169,
              0.12786595523357,
              -0.20178765058517,
              -0.21322199702263,
              0.019177278503776,
              -0.04596933349967,
              0.095825985074043,
              -0.026977458968759,
              0.068898506462574,
              -0.040126454085112,
              -0.11248335242271,
              0.073017798364162,
              0.031798433512449,
              0.10206098109484,
              0.11724981665611,
              0.15944653749466,
              0.046317953616381,
              -0.053536955267191,
              -0.12634311616421,
              -0.087950393557549,
              0.18109820783138,
              -0.025780837982893,
              0.095084562897682,
              -0.039960768073797,
              -0.010803983546793,
              0.05198547244072,
              0.041448634117842,
              0.21573619544506,
              0.096509195864201,
              0.10432627797127,
              0.081414826214314,
              -0.0075490600429475,
              -0.016233904287219,
              -0.043994277715683,
              -0.12671484053135,
              -0.0050862994976342,
              -0.059780664741993,
              -0.20216824114323,
              -0.0086077386513352,
              0.10867986828089,
              0.083661802113056,
              0.0058418605476618,
              -0.093564599752426,
              -0.073966778814793,
              0.10036297887564,
              0.046964712440968,
              0.079161174595356,
              -0.080954104661942,
              -0.075630404055119,
              -0.063016839325428,
              0.042799640446901,
              -0.13107287883759,
              0.13361950218678,
              -0.11405827850103,
              -0.092247508466244,
              0.15094122290611,
              -0.0032655638642609,
              0.098561711609364,
              -0.021631717681885,
              0.054636370390654,
              0.080647610127926,
              -0.031980577856302,
              0.020201545208693,
              0.009731444530189,
              -0.051197495311499,
              -0.19670943915844,
              0.049465917050838,
              -0.077163241803646,
              -0.030128730461001,
              0.051439046859741,
              0.10475212335587,
              0.056760255247355,
              0.028890948742628,
              0.052683096379042,
              0.12200926244259,
              -0.064134560525417,
              -0.0039646527729928,
              -0.024422809481621,
              0.08727914839983,
              -0.12900725007057,
              0.0028111690189689,
              -0.10644952952862,
              -0.10204046219587,
              0.095479264855385,
              -0.025210717692971,
              0.19465406239033
            ],
            "file": "0cb56d7d92b31fb8d6295c6a62ffc4641f468b1fd42012d29915d997ee67c000-0.jpg"
          }
      ]).to be_in(subject.all)
    end
  end

  describe '.save' do
    it 'extends existing data with new' do
      file = double(:file)
      data = [{
        id: 'ID123',
        source: 'SOURCE123'
      }]

      expect(File).to receive(:open).with(Rails.root.join('data.json'), 'w').and_yield(file)
      expect(file).to receive(:write).with(JSON.pretty_generate(data + subject.all))

      subject.save(data)
    end

    it 'updates existing data' do
      file = double(:file)
      data = [{
        id: 'SVK:SNG.O_6269',
        source: 'api.webumenia.sk',
        year: '177', # Change
        title: 'Podobizeň M.M.Hodžu',
        author: ["Klemens, Jozef Božetech"],
        url: 'http://webumenia.sk/dielo/SVK:SNG.O_6269',
        image_url: 'http://www.webumenia.sk/images/diela/SNG/13/SVK_SNG.O_6269/SVK_SNG.O_6269.jpeg'
      }]

      other = subject.all.select { |e| e[:id] != 'SVK:SNG.O_6269' }

      expect(File).to receive(:open).with(Rails.root.join('data.json'), 'w').and_yield(file)
      expect(file).to receive(:write).with(JSON.pretty_generate(data + other))

      subject.save(data)
    end
  end
end
